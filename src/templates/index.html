<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Card Collection</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .filter-header {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
            align-items: center;
            justify-content: space-between;
        }
        
        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .filter-toggle-icon {
            transition: transform 0.3s ease;
            font-size: 18px;
        }
        
        .filter-toggle-icon.expanded {
            transform: rotate(180deg);
        }
        
        .filters-wrapper {
            background: white;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filters {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }
        
        .filters.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        @media (max-width: 768px) {
            .filter-header {
                display: flex;
            }
            
            .filters-wrapper {
                border-radius: 8px;
            }
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
        }
        
        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            background: #007bff;
            color: white;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.secondary:hover {
            background: #545b62;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }
        
        .card {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .card img {
            width: 125px;
            height: auto;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
        }
        
        .card-name {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            text-align: center;
        }
        
        .card-qty {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-top: 4px;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal {
            background: white;
            border-radius: 12px;
            max-width: 1100px;
            width: 95vw;
            max-height: calc(100vh - 240px);
            overflow-y: auto;
            padding: 30px;
            position: relative;
            margin-top: 200px;
            margin-bottom: 20px;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .modal-close:hover {
            background: #f0f0f0;
        }
        
        .modal-nav-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .modal-nav {
            background: #007bff;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.2s;
            line-height: 1;
            padding: 0;
        }
        
        .modal-nav:hover:not(:disabled) {
            background: #0056b3;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: scale(1.1);
        }
        
        .modal-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: #ccc;
        }
        
        .modal-image-container img {
            width: 100%;
            max-width: 320px;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: block;
            transition: transform 0.2s;
        }
        
        .modal-image-container img:hover {
            transform: scale(1.02);
        }
        
        .modal-content {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            align-items: start;
        }
        
        @media (max-width: 900px) {
            .modal-content {
                grid-template-columns: 1fr;
            }
            
            .modal-image-container {
                max-width: 100%;
            }
        }
        
        .modal-image-container {
            position: sticky;
            top: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .modal-sections {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .modal-section {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .modal-section-title {
            background: #f8f8f8;
            padding: 8px 12px;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            color: #555;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .modal-table {
            width: 100%;
        }
        
        .modal-table tr {
            border-bottom: 1px solid #f0f0f0;
        }
        
        .modal-table tr:last-child {
            border-bottom: none;
        }
        
        .modal-table td {
            padding: 8px 12px;
            font-size: 13px;
        }
        
        .modal-table td:first-child {
            font-weight: 600;
            color: #666;
            width: 40%;
            vertical-align: top;
            background: #fafafa;
        }
        
        .modal-table td:last-child {
            color: #333;
        }
        
        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 4px;
            background: #e0e0e0;
            color: #333;
        }
        
        .attack-item, .ability-item {
            margin-bottom: 8px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        .attack-item:last-child, .ability-item:last-child {
            margin-bottom: 0;
        }
        
        .attack-name, .ability-name {
            font-weight: 600;
            color: #333;
        }
        
        .attack-cost {
            color: #666;
            font-size: 12px;
        }
        
        .attack-damage {
            color: #d32f2f;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .attack-effect, .ability-effect {
            color: #555;
            font-size: 12px;
            margin-top: 4px;
            font-style: italic;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        
        /* Color filters */
        .color-filters {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .color-filters-label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .color-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .color-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .color-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .color-badge.active {
            border-color: #333;
            box-shadow: 0 0 0 1px #333;
            transform: scale(1.05);
        }
        
        .color-badge-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container" x-data="cardApp()" x-init="init()">
        <!-- Header -->
        <header>
            <h1>üé¥ Pokemon Card Collection</h1>
        </header>
        
        <!-- Stats -->
        <div class="stats" x-show="stats">
            <div class="stat-card">
                <div class="stat-label">Unique Cards</div>
                <div class="stat-value" x-text="stats?.unique_cards || 0"></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Cards</div>
                <div class="stat-value" x-text="stats?.total_cards || 0"></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Sets</div>
                <div class="stat-value" x-text="stats?.sets_count || 0"></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Value</div>
                <div class="stat-value" x-text="'‚Ç¨' + (stats?.total_value_eur || 0).toFixed(2)"></div>
            </div>
        </div>
        
        <!-- Color Filters -->
        <div class="color-filters">
            <div class="color-filters-label">Quick Color Filter</div>
            <div class="color-badges">
                <template x-for="color in colorFilters" :key="color.name">
                    <div 
                        class="color-badge" 
                        :class="{ 'active': filters.colors.includes(color.name) }"
                        :style="'background-color: ' + color.bg + '; color: ' + color.text"
                        @click="toggleColorFilter(color.name)"
                    >
                        <span class="color-badge-dot" :style="'background-color: ' + color.dot"></span>
                        <span x-text="color.name"></span>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="filters-wrapper">
            <div class="filter-header">
                <button @click="toggleFilters()" class="filter-toggle" style="background: none; border: none; padding: 0; cursor: pointer; color: inherit; font-size: inherit;">
                    <span class="filter-toggle-icon" :class="{ 'expanded': !filtersCollapsed }">‚ñº</span>
                    <span>Filters</span>
                    <span style="color: #666; font-weight: normal; font-size: 14px;" x-show="getActiveFilterCount() > 0" x-text="'(' + getActiveFilterCount() + ' active)'"></span>
                </button>
            </div>
            <div class="filters" :class="{ 'collapsed': filtersCollapsed }">
            <div class="filter-group">
                <label class="filter-label" for="language">Language</label>
                <select id="language" x-model="filters.language" @change="loadCards()">
                    <option value="de">German</option>
                    <option value="en">English</option>
                    <option value="fr">French</option>
                    <option value="es">Spanish</option>
                    <option value="it">Italian</option>
                    <option value="pt">Portuguese</option>
                    <option value="ja">Japanese</option>
                    <option value="ko">Korean</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" for="name">Name Search</label>
                <input id="name" type="text" x-model="filters.name" @input="loadCards()" placeholder="Search cards...">
            </div>
            
            <div class="filter-group">
                <label class="filter-label" for="setId">Set ID</label>
                <select id="setId" x-model="filters.setId" @change="loadCards()">
                    <option value="">All Sets</option>
                    <template x-for="set in filterOptions.sets" :key="set">
                        <option :value="set" x-text="set"></option>
                    </template>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" for="type">Type</label>
                <select id="type" x-model="filters.type" @change="loadCards()">
                    <option value="">All Types</option>
                    <template x-for="type in filterOptions.types" :key="type">
                        <option :value="type" x-text="type"></option>
                    </template>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" for="category">Category</label>
                <select id="category" x-model="filters.category" @change="loadCards()">
                    <option value="">All Categories</option>
                    <template x-for="cat in filterOptions.categories" :key="cat">
                        <option :value="cat" x-text="cat"></option>
                    </template>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" for="rarity">Rarity</label>
                <select id="rarity" x-model="filters.rarity" @change="loadCards()">
                    <option value="">All Rarities</option>
                    <template x-for="rarity in filterOptions.rarities" :key="rarity">
                        <option :value="rarity" x-text="rarity"></option>
                    </template>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" for="stage">Stage</label>
                <select id="stage" x-model="filters.stage" @change="loadCards()">
                    <option value="">All Stages</option>
                    <template x-for="stage in filterOptions.stages" :key="stage">
                        <option :value="stage" x-text="stage"></option>
                    </template>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" for="regulationMark">Regulation Mark</label>
                <select id="regulationMark" x-model="filters.regulationMark" @change="loadCards()">
                    <option value="">All Marks</option>
                    <template x-for="mark in filterOptions.regulation_marks" :key="mark">
                        <option :value="mark" x-text="mark"></option>
                    </template>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" for="legalStandard">Standard Legal</label>
                <select id="legalStandard" x-model="filters.legalStandard" @change="loadCards()">
                    <option value="">All Cards</option>
                    <option value="true">Legal Only</option>
                    <option value="false">Not Legal</option>
                </select>
            </div>
            
            <div class="filter-group" style="align-self: end;">
                <button @click="clearFilters()" class="secondary">Clear Filters</button>
            </div>
        </div>
    </div>
        
        <!-- Loading -->
        <div class="loading" x-show="loading">
            Loading cards...
        </div>
        
        <!-- Results count -->
        <div x-show="!loading && cardGroups.length > 0" style="text-align: center; margin-bottom: 15px; color: #666; font-size: 14px;">
            Showing <span x-text="cardGroups.length"></span> unique card<span x-text="cardGroups.length !== 1 ? 's' : ''"></span>
        </div>
        
        <!-- Empty state -->
        <div x-show="!loading && cardGroups.length === 0" class="loading">
            No cards found matching your filters.
        </div>
        
        <!-- Gallery -->
        <div class="gallery" x-show="!loading && cardGroups.length > 0">
            <template x-for="group in cardGroups" :key="group.tcgdex_id">
                <div class="card" @click="openModal(group)">
                    <img :src="getThumbnailUrl(group.cards[0], filters.language)" :alt="group.cards[0].display_name" loading="lazy">
                    <div class="card-name" x-text="group.cards[0].display_name"></div>
                    <div class="card-qty" x-text="'Qty: ' + group.total_qty"></div>
                </div>
            </template>
        </div>
        
        <!-- Modal -->
        <div class="modal-overlay" x-show="selectedCard" @click.self="closeModal()" style="display: none;">
            <div class="modal" x-show="selectedCard">
                <button class="modal-close" @click="closeModal()">√ó</button>
                
                <template x-if="selectedCard">
                    <div class="modal-content">
                        <!-- Left Column: Card Image -->
                        <div class="modal-image-container">
                            <img :src="getHighQualityUrl(selectedCard.cards[0], filters.language)" :alt="selectedCard.cards[0].display_name">
                            
                            <!-- Navigation buttons under image -->
                            <div class="modal-nav-container">
                                <button class="modal-nav" @click="previousCard()" :disabled="!hasPrevious()" title="Previous card (‚Üê)">
                                    ‚Üê
                                </button>
                                <button class="modal-nav" @click="nextCard()" :disabled="!hasNext()" title="Next card (‚Üí)">
                                    ‚Üí
                                </button>
                            </div>
                        </div>
                        
                        <!-- Right Column: Card Information -->
                        <div class="modal-sections">
                            <!-- Basic Information -->
                            <div class="modal-section">
                                <div class="modal-section-title">Basic Information</div>
                                <table class="modal-table">
                                    <tr>
                                        <td>Display Name</td>
                                        <td x-text="selectedCard.cards[0].display_name"></td>
                                    </tr>
                                    <tr>
                                        <td>English Name</td>
                                        <td x-text="selectedCard.cards[0].name_en"></td>
                                    </tr>
                                    <tr>
                                        <td>Set</td>
                                        <td x-text="selectedCard.cards[0].set_id + ' #' + selectedCard.cards[0].card_number"></td>
                                    </tr>
                                    <tr>
                                        <td>TCGdex ID</td>
                                        <td x-text="selectedCard.tcgdex_id"></td>
                                    </tr>
                                    <tr x-show="selectedCard.cards[0].category">
                                        <td>Category</td>
                                        <td x-text="selectedCard.cards[0].category"></td>
                                    </tr>
                                    <tr x-show="selectedCard.cards[0].rarity">
                                        <td>Rarity</td>
                                        <td x-text="selectedCard.cards[0].rarity"></td>
                                    </tr>
                                    <tr x-show="selectedCard.cards[0].illustrator">
                                        <td>Illustrator</td>
                                        <td x-text="selectedCard.cards[0].illustrator"></td>
                                    </tr>
                                    <tr x-show="selectedCard.cards[0].regulation_mark">
                                        <td>Regulation Mark</td>
                                        <td x-text="selectedCard.cards[0].regulation_mark"></td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- Pokemon Stats (only for Pokemon cards) -->
                            <div class="modal-section" x-show="selectedCard.cards[0].category === 'Pok√©mon'">
                                <div class="modal-section-title">Pok√©mon Stats</div>
                                <table class="modal-table">
                                    <tr x-show="selectedCard.cards[0].types">
                                        <td>Type(s)</td>
                                        <td>
                                            <template x-for="type in parseTypesArray(selectedCard.cards[0].types)">
                                                <span class="type-badge" x-text="type"></span>
                                            </template>
                                        </td>
                                    </tr>
                                    <tr x-show="selectedCard.cards[0].hp">
                                        <td>HP</td>
                                        <td x-text="selectedCard.cards[0].hp"></td>
                                    </tr>
                                    <tr x-show="selectedCard.cards[0].stage">
                                        <td>Stage</td>
                                        <td x-text="selectedCard.cards[0].stage"></td>
                                    </tr>
                                    <tr x-show="selectedCard.cards[0].evolve_from">
                                        <td>Evolves From</td>
                                        <td x-text="selectedCard.cards[0].evolve_from"></td>
                                    </tr>
                                    <tr x-show="selectedCard.cards[0].retreat_cost">
                                        <td>Retreat Cost</td>
                                        <td x-text="selectedCard.cards[0].retreat_cost"></td>
                                    </tr>
                                    <tr x-show="selectedCard.cards[0].description">
                                        <td>Description</td>
                                        <td x-text="selectedCard.cards[0].description"></td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- Abilities -->
                            <div class="modal-section" x-show="selectedCard.cards[0].abilities">
                                <div class="modal-section-title">Abilities</div>
                                <table class="modal-table">
                                    <tr>
                                        <td colspan="2">
                                            <template x-for="ability in parseAbilities(selectedCard.cards[0].abilities)">
                                                <div class="ability-item">
                                                    <div>
                                                        <span class="ability-name" x-text="ability.name"></span>
                                                        <span x-show="ability.type" x-text="' (' + ability.type + ')'" style="color: #666; font-size: 12px;"></span>
                                                    </div>
                                                    <div class="ability-effect" x-show="ability.effect" x-text="ability.effect"></div>
                                                </div>
                                            </template>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- Attacks -->
                            <div class="modal-section" x-show="selectedCard.cards[0].attacks">
                                <div class="modal-section-title">Attacks</div>
                                <table class="modal-table">
                                    <tr>
                                        <td colspan="2">
                                            <template x-for="attack in parseAttacks(selectedCard.cards[0].attacks)">
                                                <div class="attack-item">
                                                    <div>
                                                        <span class="attack-name" x-text="attack.name"></span>
                                                        <span class="attack-cost" x-show="attack.cost && attack.cost.length > 0" x-text="'[' + attack.cost.join(', ') + ']'"></span>
                                                        <span class="attack-damage" x-show="attack.damage" x-text="attack.damage"></span>
                                                    </div>
                                                    <div class="attack-effect" x-show="attack.effect" x-text="attack.effect"></div>
                                                </div>
                                            </template>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- Weaknesses & Resistances -->
                            <div class="modal-section" x-show="selectedCard.cards[0].weaknesses || selectedCard.cards[0].resistances">
                                <div class="modal-section-title">Type Effectiveness</div>
                                <table class="modal-table">
                                    <tr x-show="selectedCard.cards[0].weaknesses">
                                        <td>Weakness</td>
                                        <td>
                                            <template x-for="weakness in parseTypeEffects(selectedCard.cards[0].weaknesses)">
                                                <span x-text="weakness.type + ' ' + weakness.value" style="margin-right: 8px;"></span>
                                            </template>
                                        </td>
                                    </tr>
                                    <tr x-show="selectedCard.cards[0].resistances">
                                        <td>Resistance</td>
                                        <td>
                                            <template x-for="resistance in parseTypeEffects(selectedCard.cards[0].resistances)">
                                                <span x-text="resistance.type + ' ' + resistance.value" style="margin-right: 8px;"></span>
                                            </template>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- Trainer/Energy Effect -->
                            <div class="modal-section" x-show="selectedCard.cards[0].effect">
                                <div class="modal-section-title">Effect</div>
                                <table class="modal-table">
                                    <tr x-show="selectedCard.cards[0].trainer_type">
                                        <td>Trainer Type</td>
                                        <td x-text="selectedCard.cards[0].trainer_type"></td>
                                    </tr>
                                    <tr x-show="selectedCard.cards[0].energy_type">
                                        <td>Energy Type</td>
                                        <td x-text="selectedCard.cards[0].energy_type"></td>
                                    </tr>
                                    <tr>
                                        <td>Effect Text</td>
                                        <td x-text="selectedCard.cards[0].effect"></td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- Legality -->
                            <div class="modal-section" x-show="selectedCard.cards[0].legal_standard !== null || selectedCard.cards[0].legal_expanded !== null">
                                <div class="modal-section-title">Format Legality</div>
                                <table class="modal-table">
                                    <tr x-show="selectedCard.cards[0].legal_standard !== null">
                                        <td>Standard</td>
                                        <td x-text="selectedCard.cards[0].legal_standard ? 'Legal' : 'Not Legal'"></td>
                                    </tr>
                                    <tr x-show="selectedCard.cards[0].legal_expanded !== null">
                                        <td>Expanded</td>
                                        <td x-text="selectedCard.cards[0].legal_expanded ? 'Legal' : 'Not Legal'"></td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- Your Collection -->
                            <div class="modal-section">
                                <div class="modal-section-title">Your Collection</div>
                                <table class="modal-table">
                                    <template x-for="card in selectedCard.cards">
                                        <tr>
                                            <td x-text="capitalize(card.variant)"></td>
                                            <td x-text="card.quantity + 'x'"></td>
                                        </tr>
                                    </template>
                                </table>
                            </div>
                            
                            <!-- Price -->
                            <div class="modal-section" x-show="selectedCard.cards[0].price_eur || selectedCard.cards[0].price_usd">
                                <div class="modal-section-title">Pricing</div>
                                <table class="modal-table">
                                    <tr x-show="selectedCard.cards[0].price_eur">
                                        <td>EUR</td>
                                        <td x-text="'‚Ç¨' + selectedCard.cards[0].price_eur.toFixed(2)"></td>
                                    </tr>
                                    <tr x-show="selectedCard.cards[0].price_usd">
                                        <td>USD</td>
                                        <td x-text="'$' + selectedCard.cards[0].price_usd.toFixed(2)"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
    
    <script>
        function cardApp() {
            return {
                stats: null,
                cards: [],
                cardGroups: [],
                filterOptions: {
                    types: [],
                    categories: [],
                    rarities: [],
                    stages: [],
                    sets: [],
                    regulation_marks: [],
                },
                filters: {
                    language: 'de',
                    name: '',
                    setId: '',
                    type: '',
                    category: '',
                    rarity: '',
                    stage: '',
                    regulationMark: '',
                    legalStandard: '',
                    colors: [],
                },
                colorFilters: [
                    { name: 'Red', bg: '#ffebee', text: '#c62828', dot: '#f44336' },
                    { name: 'Blue', bg: '#e3f2fd', text: '#1565c0', dot: '#2196f3' },
                    { name: 'Yellow', bg: '#fffde7', text: '#f57f17', dot: '#ffeb3b' },
                    { name: 'Green', bg: '#e8f5e9', text: '#2e7d32', dot: '#4caf50' },
                    { name: 'Black', bg: '#f5f5f5', text: '#212121', dot: '#424242' },
                    { name: 'Brown', bg: '#efebe9', text: '#4e342e', dot: '#795548' },
                    { name: 'Purple', bg: '#f3e5f5', text: '#6a1b9a', dot: '#9c27b0' },
                    { name: 'Gray', bg: '#fafafa', text: '#616161', dot: '#9e9e9e' },
                    { name: 'White', bg: '#ffffff', text: '#424242', dot: '#e0e0e0' },
                    { name: 'Pink', bg: '#fce4ec', text: '#c2185b', dot: '#e91e63' },
                ],
                loading: false,
                selectedCard: null,
                selectedCardIndex: -1,
                filtersCollapsed: true,
                
                async init() {
                    // Load filter collapse state from localStorage
                    const isMobile = window.innerWidth <= 768;
                    const savedState = localStorage.getItem('filtersCollapsed');
                    
                    // Default to collapsed on mobile, check savedState if exists
                    if (isMobile) {
                        this.filtersCollapsed = savedState === null ? true : savedState === 'true';
                    } else {
                        // On desktop, expand filters
                        this.filtersCollapsed = false;
                    }
                    
                    await this.loadFilterOptions();
                    await this.loadStats();
                    await this.loadCards();
                    
                    // Add keyboard navigation
                    document.addEventListener('keydown', (e) => {
                        if (!this.selectedCard) return;
                        
                        if (e.key === 'ArrowLeft' || e.key === 'Left') {
                            e.preventDefault();
                            this.previousCard();
                        } else if (e.key === 'ArrowRight' || e.key === 'Right') {
                            e.preventDefault();
                            this.nextCard();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            this.closeModal();
                        }
                    });
                    
                    // Update collapse state on window resize
                    window.addEventListener('resize', () => {
                        const isMobile = window.innerWidth <= 768;
                        if (!isMobile) {
                            this.filtersCollapsed = false;
                        } else {
                            // On mobile, check localStorage or default to collapsed
                            const savedState = localStorage.getItem('filtersCollapsed');
                            this.filtersCollapsed = savedState === null ? true : savedState === 'true';
                        }
                    });
                },
                
                async loadFilterOptions() {
                    try {
                        const response = await fetch('/api/filter-options');
                        this.filterOptions = await response.json();
                    } catch (error) {
                        console.error('Failed to load filter options:', error);
                    }
                },
                
                async loadStats() {
                    try {
                        const response = await fetch('/api/stats');
                        this.stats = await response.json();
                    } catch (error) {
                        console.error('Failed to load stats:', error);
                    }
                },
                
                async loadCards() {
                    this.loading = true;
                    try {
                        const params = new URLSearchParams();
                        
                        // Add all filter parameters
                        if (this.filters.language) params.append('language', this.filters.language);
                        if (this.filters.name) params.append('name', this.filters.name);
                        if (this.filters.setId) params.append('set_id', this.filters.setId);
                        if (this.filters.type) params.append('card_type', this.filters.type);
                        if (this.filters.category) params.append('category', this.filters.category);
                        if (this.filters.rarity) params.append('rarity', this.filters.rarity);
                        if (this.filters.stage) params.append('stage', this.filters.stage);
                        if (this.filters.regulationMark) params.append('regulation_mark', this.filters.regulationMark);
                        if (this.filters.legalStandard) params.append('legal_standard', this.filters.legalStandard);
                        
                        const response = await fetch('/api/cards?' + params);
                        this.cards = await response.json();
                        this.groupCards();
                    } catch (error) {
                        console.error('Failed to load cards:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                clearFilters() {
                    this.filters.name = '';
                    this.filters.setId = '';
                    this.filters.type = '';
                    this.filters.category = '';
                    this.filters.rarity = '';
                    this.filters.stage = '';
                    this.filters.regulationMark = '';
                    this.filters.legalStandard = '';
                    this.filters.colors = [];
                    this.loadCards();
                },
                
                toggleColorFilter(colorName) {
                    const index = this.filters.colors.indexOf(colorName);
                    if (index > -1) {
                        this.filters.colors.splice(index, 1);
                    } else {
                        this.filters.colors.push(colorName);
                    }
                    this.applyColorFilter();
                },
                
                applyColorFilter() {
                    // Re-filter the card groups based on selected colors
                    if (this.filters.colors.length === 0) {
                        // No color filter, show all groups
                        return;
                    }
                    // Note: This is a client-side filter for now
                    // We'll filter based on card types which often match colors
                    // TODO: This could be enhanced by mapping types to colors properly
                    this.groupCards();
                },
                
                toggleFilters() {
                    this.filtersCollapsed = !this.filtersCollapsed;
                    localStorage.setItem('filtersCollapsed', this.filtersCollapsed);
                },
                
                getActiveFilterCount() {
                    let count = 0;
                    if (this.filters.name) count++;
                    if (this.filters.setId) count++;
                    if (this.filters.type) count++;
                    if (this.filters.category) count++;
                    if (this.filters.rarity) count++;
                    if (this.filters.stage) count++;
                    if (this.filters.regulationMark) count++;
                    if (this.filters.legalStandard) count++;
                    if (this.filters.colors.length > 0) count++;
                    return count;
                },
                
                groupCards() {
                    const grouped = {};
                    
                    // Type to color mapping for Pokemon TCG
                    const typeColorMap = {
                        'Fire': 'Red',
                        'Water': 'Blue',
                        'Lightning': 'Yellow',
                        'Grass': 'Green',
                        'Fighting': 'Brown',
                        'Psychic': 'Purple',
                        'Darkness': 'Black',
                        'Metal': 'Gray',
                        'Fairy': 'Pink',
                        'Dragon': 'Yellow',
                        'Colorless': 'White',
                        // German types
                        'Feuer': 'Red',
                        'Wasser': 'Blue',
                        'Elektro': 'Yellow',
                        'Pflanze': 'Green',
                        'Kampf': 'Brown',
                        'Psycho': 'Purple',
                        'Finsternis': 'Black',
                        'Metall': 'Gray',
                        'Fee': 'Pink',
                        'Drache': 'Yellow',
                        'Farblos': 'White',
                    };
                    
                    for (const card of this.cards) {
                        if (!grouped[card.tcgdex_id]) {
                            grouped[card.tcgdex_id] = {
                                tcgdex_id: card.tcgdex_id,
                                cards: [],
                                total_qty: 0
                            };
                        }
                        grouped[card.tcgdex_id].cards.push(card);
                        grouped[card.tcgdex_id].total_qty += card.quantity;
                    }
                    
                    let groups = Object.values(grouped);
                    
                    // Apply color filter if active
                    if (this.filters.colors.length > 0) {
                        groups = groups.filter(group => {
                            const card = group.cards[0];
                            if (!card.types) return false;
                            
                            // Parse types
                            let types = [];
                            if (typeof card.types === 'string') {
                                try {
                                    types = JSON.parse(card.types);
                                } catch {
                                    types = [card.types];
                                }
                            } else if (Array.isArray(card.types)) {
                                types = card.types;
                            }
                            
                            // Check if any type matches selected colors
                            return types.some(type => {
                                const color = typeColorMap[type];
                                return color && this.filters.colors.includes(color);
                            });
                        });
                    }
                    
                    this.cardGroups = groups;
                },
                
                getThumbnailUrl(card, lang) {
                    if (!card.image_url) return '';
                    return card.image_url
                        .replace('/en/', '/' + lang + '/')
                        .replace('/high.png', '/low.webp');
                },
                
                getHighQualityUrl(card, lang) {
                    if (!card.image_url) return '';
                    return card.image_url.replace('/en/', '/' + lang + '/');
                },
                
                parseTypes(types) {
                    if (!types) return '';
                    if (typeof types === 'string') {
                        try {
                            types = JSON.parse(types);
                        } catch {
                            return types;
                        }
                    }
                    return Array.isArray(types) ? types.join(', ') : types;
                },
                
                parseTypesArray(types) {
                    if (!types) return [];
                    if (typeof types === 'string') {
                        try {
                            types = JSON.parse(types);
                        } catch {
                            return [];
                        }
                    }
                    return Array.isArray(types) ? types : [];
                },
                
                parseAttacks(attacks) {
                    if (!attacks) return [];
                    if (typeof attacks === 'string') {
                        try {
                            attacks = JSON.parse(attacks);
                        } catch {
                            return [];
                        }
                    }
                    return Array.isArray(attacks) ? attacks : [];
                },
                
                parseAbilities(abilities) {
                    if (!abilities) return [];
                    if (typeof abilities === 'string') {
                        try {
                            abilities = JSON.parse(abilities);
                        } catch {
                            return [];
                        }
                    }
                    return Array.isArray(abilities) ? abilities : [];
                },
                
                parseTypeEffects(effects) {
                    if (!effects) return [];
                    if (typeof effects === 'string') {
                        try {
                            effects = JSON.parse(effects);
                        } catch {
                            return [];
                        }
                    }
                    return Array.isArray(effects) ? effects : [];
                },
                
                capitalize(str) {
                    return str.charAt(0).toUpperCase() + str.slice(1);
                },
                
                openModal(cardGroup) {
                    this.selectedCardIndex = this.cardGroups.findIndex(g => g.tcgdex_id === cardGroup.tcgdex_id);
                    this.selectedCard = cardGroup;
                },
                
                closeModal() {
                    this.selectedCard = null;
                    this.selectedCardIndex = -1;
                },
                
                previousCard() {
                    if (this.selectedCardIndex > 0) {
                        this.selectedCardIndex--;
                        this.selectedCard = this.cardGroups[this.selectedCardIndex];
                    }
                },
                
                nextCard() {
                    if (this.selectedCardIndex < this.cardGroups.length - 1) {
                        this.selectedCardIndex++;
                        this.selectedCard = this.cardGroups[this.selectedCardIndex];
                    }
                },
                
                hasPrevious() {
                    return this.selectedCardIndex > 0;
                },
                
                hasNext() {
                    return this.selectedCardIndex < this.cardGroups.length - 1;
                }
            };
        }
    </script>
</body>
</html>
