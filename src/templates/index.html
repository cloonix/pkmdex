<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Card Collection</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .filters {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
        }
        
        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            background: #007bff;
            color: white;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.secondary:hover {
            background: #545b62;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }
        
        .card {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .card img {
            width: 125px;
            height: auto;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
        }
        
        .card-name {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            text-align: center;
        }
        
        .card-qty {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-top: 4px;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .modal-close:hover {
            background: #f0f0f0;
        }
        
        .modal img {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 8px;
            margin-bottom: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        .modal-field {
            margin-bottom: 12px;
        }
        
        .modal-label {
            font-weight: 600;
            margin-right: 8px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container" x-data="cardApp()" x-init="init()">
        <!-- Header -->
        <header>
            <h1>ðŸŽ´ Pokemon Card Collection</h1>
        </header>
        
        <!-- Stats -->
        <div class="stats" x-show="stats">
            <div class="stat-card">
                <div class="stat-label">Unique Cards</div>
                <div class="stat-value" x-text="stats?.unique_cards || 0"></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Cards</div>
                <div class="stat-value" x-text="stats?.total_cards || 0"></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Sets</div>
                <div class="stat-value" x-text="stats?.sets_count || 0"></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Value</div>
                <div class="stat-value" x-text="'â‚¬' + (stats?.total_value_eur || 0).toFixed(2)"></div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label" for="language">Language</label>
                <select id="language" x-model="filters.language" @change="loadCards()">
                    <option value="de">German</option>
                    <option value="en">English</option>
                    <option value="fr">French</option>
                    <option value="es">Spanish</option>
                    <option value="it">Italian</option>
                    <option value="pt">Portuguese</option>
                    <option value="ja">Japanese</option>
                    <option value="ko">Korean</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" for="name">Name Search</label>
                <input id="name" type="text" x-model="filters.name" @input="loadCards()" placeholder="Search cards...">
            </div>
            
            <div class="filter-group">
                <label class="filter-label" for="setId">Set ID</label>
                <select id="setId" x-model="filters.setId" @change="loadCards()">
                    <option value="">All Sets</option>
                    <template x-for="set in filterOptions.sets" :key="set">
                        <option :value="set" x-text="set"></option>
                    </template>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" for="type">Type</label>
                <select id="type" x-model="filters.type" @change="loadCards()">
                    <option value="">All Types</option>
                    <template x-for="type in filterOptions.types" :key="type">
                        <option :value="type" x-text="type"></option>
                    </template>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" for="category">Category</label>
                <select id="category" x-model="filters.category" @change="loadCards()">
                    <option value="">All Categories</option>
                    <template x-for="cat in filterOptions.categories" :key="cat">
                        <option :value="cat" x-text="cat"></option>
                    </template>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" for="rarity">Rarity</label>
                <select id="rarity" x-model="filters.rarity" @change="loadCards()">
                    <option value="">All Rarities</option>
                    <template x-for="rarity in filterOptions.rarities" :key="rarity">
                        <option :value="rarity" x-text="rarity"></option>
                    </template>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label" for="stage">Stage</label>
                <select id="stage" x-model="filters.stage" @change="loadCards()">
                    <option value="">All Stages</option>
                    <template x-for="stage in filterOptions.stages" :key="stage">
                        <option :value="stage" x-text="stage"></option>
                    </template>
                </select>
            </div>
            
            <div class="filter-group" style="align-self: end;">
                <button @click="clearFilters()" class="secondary">Clear Filters</button>
            </div>
        </div>
        
        <!-- Loading -->
        <div class="loading" x-show="loading">
            Loading cards...
        </div>
        
        <!-- Results count -->
        <div x-show="!loading && cardGroups.length > 0" style="text-align: center; margin-bottom: 15px; color: #666; font-size: 14px;">
            Showing <span x-text="cardGroups.length"></span> unique card<span x-text="cardGroups.length !== 1 ? 's' : ''"></span>
        </div>
        
        <!-- Empty state -->
        <div x-show="!loading && cardGroups.length === 0" class="loading">
            No cards found matching your filters.
        </div>
        
        <!-- Gallery -->
        <div class="gallery" x-show="!loading && cardGroups.length > 0">
            <template x-for="group in cardGroups" :key="group.tcgdex_id">
                <div class="card" @click="openModal(group)">
                    <img :src="getThumbnailUrl(group.cards[0], filters.language)" :alt="group.cards[0].display_name" loading="lazy">
                    <div class="card-name" x-text="group.cards[0].display_name"></div>
                    <div class="card-qty" x-text="'Qty: ' + group.total_qty"></div>
                </div>
            </template>
        </div>
        
        <!-- Modal -->
        <div class="modal-overlay" x-show="selectedCard" @click.self="closeModal()" style="display: none;">
            <div class="modal" x-show="selectedCard">
                <button class="modal-close" @click="closeModal()">Ã—</button>
                
                <template x-if="selectedCard">
                    <div>
                        <img :src="getHighQualityUrl(selectedCard.cards[0], filters.language)" :alt="selectedCard.cards[0].display_name">
                        
                        <div class="modal-field">
                            <span class="modal-label">Display Name:</span>
                            <span x-text="selectedCard.cards[0].display_name"></span>
                        </div>
                        
                        <div class="modal-field">
                            <span class="modal-label">English Name:</span>
                            <span x-text="selectedCard.cards[0].name_en"></span>
                        </div>
                        
                        <div class="modal-field">
                            <span class="modal-label">Set:</span>
                            <span x-text="selectedCard.cards[0].set_id + ' #' + selectedCard.cards[0].card_number"></span>
                        </div>
                        
                        <div class="modal-field">
                            <span class="modal-label">TCGdex ID:</span>
                            <span x-text="selectedCard.tcgdex_id"></span>
                        </div>
                        
                        <div class="modal-field" x-show="selectedCard.cards[0].types">
                            <span class="modal-label">Type:</span>
                            <span x-text="parseTypes(selectedCard.cards[0].types)"></span>
                        </div>
                        
                        <div class="modal-field" x-show="selectedCard.cards[0].hp">
                            <span class="modal-label">HP:</span>
                            <span x-text="selectedCard.cards[0].hp"></span>
                        </div>
                        
                        <div class="modal-field" x-show="selectedCard.cards[0].stage">
                            <span class="modal-label">Stage:</span>
                            <span x-text="selectedCard.cards[0].stage"></span>
                        </div>
                        
                        <div class="modal-field" x-show="selectedCard.cards[0].rarity">
                            <span class="modal-label">Rarity:</span>
                            <span x-text="selectedCard.cards[0].rarity"></span>
                        </div>
                        
                        <div class="modal-field">
                            <span class="modal-label">Your Collection:</span>
                            <div style="margin-left: 20px;">
                                <template x-for="card in selectedCard.cards">
                                    <div x-text="'- ' + capitalize(card.variant) + ': ' + card.quantity + 'x'"></div>
                                </template>
                            </div>
                        </div>
                        
                        <div class="modal-field" x-show="selectedCard.cards[0].price_eur">
                            <span class="modal-label">Price:</span>
                            <span x-text="'â‚¬' + selectedCard.cards[0].price_eur.toFixed(2)"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
    
    <script>
        function cardApp() {
            return {
                stats: null,
                cards: [],
                cardGroups: [],
                filterOptions: {
                    types: [],
                    categories: [],
                    rarities: [],
                    stages: [],
                    sets: [],
                },
                filters: {
                    language: 'de',
                    name: '',
                    setId: '',
                    type: '',
                    category: '',
                    rarity: '',
                    stage: '',
                },
                loading: false,
                selectedCard: null,
                
                async init() {
                    await this.loadFilterOptions();
                    await this.loadStats();
                    await this.loadCards();
                },
                
                async loadFilterOptions() {
                    try {
                        const response = await fetch('/api/filter-options');
                        this.filterOptions = await response.json();
                    } catch (error) {
                        console.error('Failed to load filter options:', error);
                    }
                },
                
                async loadStats() {
                    try {
                        const response = await fetch('/api/stats');
                        this.stats = await response.json();
                    } catch (error) {
                        console.error('Failed to load stats:', error);
                    }
                },
                
                async loadCards() {
                    this.loading = true;
                    try {
                        const params = new URLSearchParams();
                        
                        // Add all filter parameters
                        if (this.filters.language) params.append('language', this.filters.language);
                        if (this.filters.name) params.append('name', this.filters.name);
                        if (this.filters.setId) params.append('set_id', this.filters.setId);
                        if (this.filters.type) params.append('card_type', this.filters.type);
                        if (this.filters.category) params.append('category', this.filters.category);
                        if (this.filters.rarity) params.append('rarity', this.filters.rarity);
                        if (this.filters.stage) params.append('stage', this.filters.stage);
                        
                        const response = await fetch('/api/cards?' + params);
                        this.cards = await response.json();
                        this.groupCards();
                    } catch (error) {
                        console.error('Failed to load cards:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                clearFilters() {
                    this.filters.name = '';
                    this.filters.setId = '';
                    this.filters.type = '';
                    this.filters.category = '';
                    this.filters.rarity = '';
                    this.filters.stage = '';
                    this.loadCards();
                },
                
                groupCards() {
                    const grouped = {};
                    for (const card of this.cards) {
                        if (!grouped[card.tcgdex_id]) {
                            grouped[card.tcgdex_id] = {
                                tcgdex_id: card.tcgdex_id,
                                cards: [],
                                total_qty: 0
                            };
                        }
                        grouped[card.tcgdex_id].cards.push(card);
                        grouped[card.tcgdex_id].total_qty += card.quantity;
                    }
                    this.cardGroups = Object.values(grouped);
                },
                
                getThumbnailUrl(card, lang) {
                    if (!card.image_url) return '';
                    return card.image_url
                        .replace('/en/', '/' + lang + '/')
                        .replace('/high.png', '/low.webp');
                },
                
                getHighQualityUrl(card, lang) {
                    if (!card.image_url) return '';
                    return card.image_url.replace('/en/', '/' + lang + '/');
                },
                
                parseTypes(types) {
                    if (!types) return '';
                    if (typeof types === 'string') {
                        try {
                            types = JSON.parse(types);
                        } catch {
                            return types;
                        }
                    }
                    return Array.isArray(types) ? types.join(', ') : types;
                },
                
                capitalize(str) {
                    return str.charAt(0).toUpperCase() + str.slice(1);
                },
                
                openModal(cardGroup) {
                    this.selectedCard = cardGroup;
                },
                
                closeModal() {
                    this.selectedCard = null;
                }
            };
        }
    </script>
</body>
</html>
